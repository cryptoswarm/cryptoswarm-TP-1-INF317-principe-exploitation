// C program to implement one side of FIFO 
// This side reads first, then reads 
#include <stdio.h> 
#include <string.h> 
#include <fcntl.h> 
#include <sys/stat.h> 
#include <sys/types.h> 
#include <unistd.h> 
#include <stdlib.h>
#include <math.h>

void traiterRequete(char *requte, char **tabMotRequte )
{
	//char **tabMotRequte = (char**)malloc(4 * sizeof(char *));


	if(tabMotRequte = NULL){
		perror("malloc failed");
		exit(1);
	}
	char str[strlen(requte)+1];
	strcpy(str, requte);
	char * pch;
	int i = 0;

	pch= strtok(str,", .-");

	while(pch != NULL){

		tabMotRequte[i] = (char*)malloc(strlen(pch) +1 );
		strcpy(tabMotRequte[i], pch);
		++i;
		pch= strtok(NULL, " ,.-");
	}
	tabMotRequte[i] = NULL;
	//return tabMotRequte;
}
double calculerSurfSquare(int x)
{
	return pow(x, 2);
}

double calculerSurfRectangle(int x, int y)
{
	return x*y;
}
double calculerSurfTriangle(int x, int y)
{
	return ( (double)x * y ) / 2;
}

double calculerSurface(char **x)
{
	double surface = 0.0;
	if(strcmp(x[2], "Su*") == 0 && strcmp(x[3], "C*")==0 ){
		surface = calculerSurfSquare( atoi( x[1] ) );
	}else if( strcmp(x[2], "Su*") == 0 && strcmp(x[3], "R")==0 ){
		surface = calculerSurfRectangle( atoi( x[0] ), atoi( x[1] ) );
	}else if( strcmp(x[2], "Su*") == 0 && strcmp(x[3], "T")==0 ){
		surface = calculerSurfTriangle( atoi( x[0] ), atoi( x[1] ) );
	}
	return surface;
}


int quitterUnClient(char *str)
{
	int ret = 0;
	if( str[strlen(str) -1 ] == '\n' )
		str[strlen(str) -1 ] = '\0';

	if( strcmp(str, "FIN") ==0 ){
		printf("Un client vient de quitter! \n");
	}else if( strcmp(str, "FINFIN") ==0 ){
		ret = 1;
	}
	return ret;
}

#define NAME_SIZE 100

int main()
{
	int fd;
	int fdread;
	int fdwrite;
	int i = 0;
	int kk =0;
	char requete[100];
	char buffer[100];
	char *input;
	input = calloc(NAME_SIZE, sizeof(char));

	char *myfifo = "TestFifo"; //fifo filr path
	char *tube_serveur = "tube_serveur";
	char *tube_client = "tube_client";

	mkfifo(myfifo, 0666);//creating the named file(FIFO)

	mkfifo(tube_serveur, 0666);
	mkfifo(tube_client, 0666);

	char arr1[80], arr2[80];

	char **tabMotRequte = (char**)malloc(4 * sizeof(char *));
	//char **tabMotRequte2 = (char**)malloc(4 * sizeof(char *));
	char * pch;
	while(1)
	{

		fdread = open(tube_serveur, O_RDONLY);
		//read(fdread, requete, 100 );
		//printf("La requete est : %s\n",requete);
		read(fdread, input, NAME_SIZE);
		close(fdread);

		char str[strlen(input)+1];
		strcpy(str, input);
		pch = strtok (str," ,.-;");
		while(pch != NULL)
		{
			//printf("pch %s\n",pch);
			tabMotRequte[i] = (char*)malloc(strlen(pch) +1 );
			strcpy(tabMotRequte[i] , pch);
			printf("tabMotRequte[i] = %s\n", tabMotRequte[i]);
			++i;
			pch = strtok (NULL, " ,.-;");
		}

		int surface=  calculerSurface(tabMotRequte);
		printf("surface is %d\n", surface);
		sprintf(buffer, "la surface du carreÃÅ est : %d", surface);
		printf("buffer %s\n",buffer);



		fdwrite = open(tube_client, O_WRONLY);
		write(fdwrite, buffer, strlen(buffer)+1);
		close(fdwrite);

/*
		fd = open(myfifo, O_WRONLY); //first open in write only
		fgets(arr2, 80, stdin); // take input arriving from user

		write(fd, arr2, strlen(arr2)+1);//write the input arriving oon FIFO
		close(fd); //and close it

		fd = open(myfifo, O_RDONLY); //open fifo for read only

		read(fd, arr1, sizeof(arr1)); //read from FIFO

		printf("USER2: %s\n", arr1); //printf the read msg
		close(fd);
*/
		if ( quitterUnClient(arr1) ){
			printf("I'll display the content of the file\n");
			break;
		}
	}
	return 0;
}


/*
106         traiterRequete(input, tabMotRequte2);
107 
108         while(tabMotRequte2[kk] != NULL){
109             printf("motRequete[i] =%s\n ",tabMotRequte2[i]);
110             ++kk;
111         }
*/
